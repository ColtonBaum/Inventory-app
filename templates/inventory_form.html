{% extends "base.html" %}
{% block title %}Inventory – Trailer #{{ trailer.id }}{% endblock %}

{% block head_extra %}
<style>
  :root{
    --fg:#111827; --muted:#6b7280; --border:#e5e7eb; --bg:#ffffff; --bg-soft:#f9fafb;
    --primary:#2563eb; --primary-hover:#1d4ed8; --danger:#ef4444;
  }
  .wrap { background:var(--bg); border:1px solid var(--border); border-radius:12px; }
  .wrap .hd { padding:16px 18px; border-bottom:1px solid var(--border); }
  .wrap .bd { padding:12px 12px 90px; }
  .hd h2 { margin:0; font-size:18px; color:var(--fg); }
  .meta { display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:8px 20px; margin:6px 0 0; }
  .meta div { color:var(--fg); font-size:15px; }
  @media (max-width:900px){ .meta { grid-template-columns:1fr; } }
  .accordion { border:1px solid var(--border); border-radius:12px; overflow:hidden; }
  .acc-item + .acc-item { border-top:1px solid var(--border); }
  .acc-header{
    width:100%; background:var(--bg-soft); padding:14px;
    display:flex; align-items:center; justify-content:space-between;
    border:none; cursor:pointer; text-align:left; font-size:16px;
  }
  .acc-title { font-weight:600; color:var(--fg); display:flex; align-items:center; gap:8px; }
  .acc-title .caret { display:inline-block; transition:transform .2s ease; }
  .acc-item.open .acc-title .caret { transform:rotate(90deg); }
  .acc-count { color:var(--muted); font-size:14px }
  .acc-body { display:none; background:#fff; }
  .acc-item.open .acc-body { display:block; }
  .item { padding:14px; border-top:1px dashed var(--border); }
  .item:first-child { border-top:none; }
  .row1 { display:grid; gap:10px; grid-template-columns:1fr; }
  .label { font-size:13px; color:var(--muted); margin-bottom:4px; }
  .val { font-size:16px; color:var(--fg); }
  .qty input[type="number"]{
    width:180px; max-width:100%;
    padding:12px 14px; border:1px solid var(--border); border-radius:10px; background:var(--bg-soft);
    font-size:16px;
  }
  .row2 { display:flex; flex-direction:column; gap:12px; margin-top:12px; }
  .chk { display:flex; align-items:center; gap:10px; font-size:16px; color:var(--fg); padding:8px 0; }
  .chk input[type="checkbox"]{ width:22px; height:22px; min-width:22px; min-height:22px; accent-color: var(--primary); }

  /* reveal-on-check note inputs */
  .note { display:none; margin-left:32px; }
  .note input[type="text"]{
    width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; font-size:16px;
  }

  .controls-top { display:flex; justify-content:space-between; align-items:center; gap:10px; margin:16px 0 8px; }
  .controls-top h3 { margin:0; color:var(--fg); font-size:18px; }
  .btn { appearance:none; border:none; border-radius:10px; padding:12px 16px; background:var(--primary); color:#fff; cursor:pointer; font-size:16px; }
  .btn:hover { background:var(--primary-hover); }
  .btn.ghost { background:#fff; color:var(--fg); border:1px solid var(--border); }
  .btn.muted { background:#6b7280; }
  .name-field { margin:12px 0 6px; }
  .name-field input { width:320px; max-width:100%; padding:12px 14px; border:1px solid var(--border); border-radius:10px; font-size:16px; }
  .hint { color:var(--muted); font-size:13px; margin-top:4px; }
  .actions-sticky{
    position:sticky; bottom:0; left:0; right:0; background:#fff; border-top:1px solid var(--border);
    padding:10px 12px; display:flex; gap:10px; justify-content:space-between; z-index:10;
    border-bottom-left-radius:12px; border-bottom-right-radius:12px;
  }
  .actions-sticky .btn { text-align:center; }
  #expandAll, #collapseAll { padding:10px 14px; font-size:16px; }
  @media (min-width:1100px){ .wrap .bd { padding:16px 18px 100px; } }

  /* tiny toast */
  .toast {
    position: fixed; right: 14px; bottom: 14px; background:#111827; color:#fff;
    padding:10px 12px; border-radius:10px; font-size:14px; opacity:0; pointer-events:none;
    transform: translateY(10px); transition: opacity .2s ease, transform .2s ease;
  }
  .toast.show { opacity:1; transform: translateY(0); pointer-events:auto; }
</style>
{% endblock %}

{% block content %}
<div class="wrap">
  <div class="hd">
    <h2>Inventory Form – Trailer #{{ trailer.id }}</h2>
    <div class="meta">
      <div><strong>Job Name:</strong> {{ trailer.job_name }}</div>
      <div><strong>Job Number:</strong> {{ trailer.job_number }}</div>
      <div><strong>Location:</strong> {{ trailer.location }}</div>
      <div><strong>Tooling List:</strong> {{ trailer.tooling_list_name }}</div>
      <div><strong>Assigned User:</strong> {{ trailer.assigned_user or '—' }}</div>
      {# NEW: LN-25 with broad fallbacks #}
      {% set ln25 = trailer.ln_25s or trailer.ln_25 or trailer.ln25 or trailer.lN_25s or trailer.LN_25 or trailer.LN25 or trailer.LN_25s or trailer.ln25s %}
      <div><strong>LN-25:</strong> {{ ln25 or '—' }}</div>
    </div>
  </div>

  <div class="bd">
    <!-- add id so autosave can target the form -->
    <form id="inventory-form" method="POST" action="{{ url_for('trailer_assignment.trailer_update', trailer_id=trailer.id) }}">
      {% if not read_only %}
      <div class="name-field">
        <label class="label">Your Name (who is filling this out)</label><br/>
        <input type="text" name="assigned_user" value="{{ trailer.assigned_user or '' }}" placeholder="e.g., Jane Smith" autocomplete="name" />
        <div class="hint">This name will appear as the Assigned User on the dashboard and invoices.</div>
      </div>
      {% endif %}

      <div class="controls-top">
        <h3>Tooling Inventory</h3>
        <div>
          <button type="button" id="expandAll" class="btn ghost">Expand All</button>
          <button type="button" id="collapseAll" class="btn ghost">Collapse All</button>
        </div>
      </div>

      <div class="accordion" id="inv-accordion">
        {% for group in tooling_list|groupby('Category') %}
          {% set category = group.grouper or 'General' %}
          {% set items = group.list %}
          <!-- data-cat is used to save/restore open sections -->
          <div class="acc-item {% if loop.first %}open{% endif %}" data-cat="{{ category }}">
            <button type="button" class="acc-header" aria-expanded="{% if loop.first %}true{% else %}false{% endif %}">
              <span class="acc-title"><span class="caret">▶</span> {{ category }}</span>
              <span class="acc-count">{{ items|length }} items</span>
            </button>
            <div class="acc-body">
              {% for item in items %}
                {% set num = item['Item Number'] %}
                {% set name = item['Item Name'] %}
                {% set expected = item.get('Quantity', 0) %}
                {% set ex = existing[num] if existing and existing.get(num) else None %}
                {% set ex_missing = ex and ('Missing' in ex.statuses) %}
                {% set ex_redtag  = ex and ('Red Tag' in ex.statuses) %}
                {% set ex_complete = ex and ('Complete' in ex.statuses) %}
                {% set note_missing = (ex.notes.missing if ex and ex.notes and ex.notes.get('missing') else '') %}
                {% set note_redtag  = (ex.notes.redtag  if ex and ex.notes and ex.notes.get('redtag')  else '') %}

                <div class="item" data-item="{{ num }}">
                  <div class="row1">
                    <div>
                      <div class="label">Item Name</div>
                      <div class="val">{{ name }}</div>
                    </div>
                    <div>
                      <div class="label">Item #</div>
                      <div class="val">#{{ num }}</div>
                    </div>
                    <div class="qty">
                      <div class="label">Quantity (expected)</div>
                      <input type="number" name="{{ num }}_quantity" value="{{ expected }}" readonly title="Quantity is fixed for this list" inputmode="numeric" {% if read_only %}tabindex="-1"{% endif %} />
                    </div>
                  </div>

                  <div class="row2">
                    <!-- Missing -->
                    <label class="chk">
                      <input type="checkbox" name="{{ num }}_status_missing" value="Missing" {% if ex_missing %}checked{% endif %} {% if read_only %}disabled{% endif %} />
                      Missing
                    </label>
                    <div class="note note-missing" {% if ex_missing %}style="display:block"{% endif %}>
                      <input type="text" name="{{ num }}_note_missing" placeholder="Missing notes…" value="{{ note_missing }}" {% if read_only %}readonly{% endif %} />
                    </div>

                    <!-- Red Tag -->
                    <label class="chk">
                      <input type="checkbox" name="{{ num }}_status_redtag" value="Red Tag" {% if ex_redtag %}checked{% endif %} {% if read_only %}disabled{% endif %} />
                      Red Tag
                    </label>
                    <div class="note note-redtag" {% if ex_redtag %}style="display:block"{% endif %}>
                      <input type="text" name="{{ num }}_note_redtag" placeholder="Red tag notes…" value="{{ note_redtag }}" {% if read_only %}readonly{% endif %} />
                    </div>

                    <!-- Complete -->
                    <label class="chk">
                      <input type="checkbox" name="{{ num }}_status_complete" value="Complete" {% if ex_complete %}checked{% endif %} {% if read_only %}disabled{% endif %} />
                      Complete
                    </label>

                    <input type="hidden" name="{{ num }}_item_name" value="{{ name }}">
                    <input type="hidden" name="{{ num }}_category" value="{{ category }}">
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        {% endfor %}
      </div>

      {% if credit_back_items %}
        <h3 style="margin:20px 0 8px; color:var(--fg); font-size:18px;">Extra Tooling Credit-Back</h3>
        <div class="accordion">
          <div class="acc-item open" data-cat="__extras__">
            <button type="button" class="acc-header" aria-expanded="true">
              <span class="acc-title"><span class="caret">▶</span> Extra Tooling</span>
              <span class="acc-count">{{ credit_back_items|length }} items</span>
            </button>
            <div class="acc-body">
              {% for item in credit_back_items %}
                <div class="item">
                  <div class="row1">
                    <div>
                      <div class="label">Item Name</div>
                      <div class="val">{{ item.item_name }}</div>
                    </div>
                    <div>
                      <div class="label">Item #</div>
                      <div class="val">#{{ item.item_number }}</div>
                    </div>
                    <div class="qty">
                      <div class="label">Quantity (expected)</div>
                      <input type="number" name="cb_{{ loop.index0 }}_quantity" value="{{ item.quantity }}" {% if read_only %}readonly tabindex="-1"{% endif %} inputmode="numeric" />
                    </div>
                  </div>

                  <div class="row2">
                    <!-- Missing -->
                    <label class="chk">
                      <input type="checkbox" name="cb_{{ loop.index0 }}_missing" value="Missing" {% if read_only %}disabled{% endif %} />
                      Missing
                    </label>
                    <div class="note note-missing">
                      <input type="text" name="cb_{{ loop.index0 }}_note_missing" placeholder="Missing notes…" {% if read_only %}readonly{% endif %} />
                    </div>

                    <!-- Red Tag -->
                    <label class="chk">
                      <input type="checkbox" name="cb_{{ loop.index0 }}_redtag" value="Red Tag" {% if read_only %}disabled{% endif %} />
                      Red Tag
                    </label>
                    <div class="note note-redtag">
                      <input type="text" name="cb_{{ loop.index0 }}_note_redtag" placeholder="Red tag notes…" {% if read_only %}readonly{% endif %} />
                    </div>

                    <!-- Complete -->
                    <label class="chk">
                      <input type="checkbox" name="cb_{{ loop.index0 }}_complete" value="Complete" {% if read_only %}disabled{% endif %} />
                      Complete
                    </label>

                    <input type="hidden" name="cb_{{ loop.index0 }}_item_name" value="{{ item.item_name }}">
                    <input type="hidden" name="cb_{{ loop.index0 }}_item_number" value="{{ item.item_number }}">
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        </div>
      {% endif %}

      {% if not read_only %}
        <div class="actions-sticky">
          <div style="display:flex; gap:10px;">
            <button class="btn" type="submit">Submit Inventory</button>
            <a class="btn ghost" id="clear-draft" href="#" style="text-decoration:none; display:inline-flex; align-items:center; justify-content:center;">Clear Draft</a>
          </div>
          <a class="btn muted" href="{{ url_for('inventory.dashboard') }}" style="text-decoration:none; display:inline-flex; align-items:center; justify-content:center;">Cancel</a>
        </div>
      {% else %}
        <div class="actions-sticky">
          <a class="btn" href="{{ url_for('inventory.dashboard') }}" style="text-decoration:none; display:inline-flex; align-items:center; justify-content:center;">Back to Dashboard</a>
        </div>
      {% endif %}
    </form>
  </div>
</div>

<!-- tiny toast for restore/save status -->
<div id="draft-toast" class="toast" role="status" aria-live="polite"></div>

<!-- JSON blob with server values (no Jinja in JS) -->
<script id="inv-values" type="application/json">
  {{ {'trailer_id': trailer.id, 'who': (trailer.assigned_user or 'anon')|replace(':','_') } | tojson }}
</script>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // accordion toggle
    document.body.addEventListener('click', function(e) {
      const header = e.target.closest('.acc-header');
      if (!header) return;
      const item = header.closest('.acc-item');
      if (!item) return;
      const willOpen = !item.classList.contains('open');
      item.classList.toggle('open', willOpen);
      header.setAttribute('aria-expanded', willOpen ? 'true' : 'false');
      if (window.__inv_saveOpenState) window.__inv_saveOpenState();
    });

    const accordion = document.getElementById('inv-accordion');
    const expandAllBtn = document.getElementById('expandAll');
    const collapseAllBtn = document.getElementById('collapseAll');
    function setAll(open){
      if (!accordion) return;
      accordion.querySelectorAll('.acc-item').forEach(function(item){
        const header = item.querySelector('.acc-header');
        item.classList.toggle('open', open);
        if (header) header.setAttribute('aria-expanded', open ? 'true' : 'false');
      });
      if (window.__inv_saveOpenState) window.__inv_saveOpenState();
    }
    if (expandAllBtn) expandAllBtn.addEventListener('click', function(){ setAll(true); });
    if (collapseAllBtn) collapseAllBtn.addEventListener('click', function(){ setAll(false); });

    // reveal text inputs for Missing / Red Tag only when checked
    function wireItem(itemEl){
      const missing = itemEl.querySelector('input[name$="_status_missing"]') || itemEl.querySelector('input[name^="cb_"][name$="_missing"]');
      const redtag  = itemEl.querySelector('input[name$="_status_redtag"]')  || itemEl.querySelector('input[name^="cb_"][name$="_redtag"]');
      const noteMissing = itemEl.querySelector('.note-missing');
      const noteRedtag  = itemEl.querySelector('.note-redtag');

      if (missing) {
        const syncMissing = ()=>{ if(noteMissing) noteMissing.style.display = missing.checked ? 'block' : 'none'; };
        missing.addEventListener('change', syncMissing);
        syncMissing();
      }
      if (redtag) {
        const syncRed = ()=>{ if(noteRedtag) noteRedtag.style.display = redtag.checked ? 'block' : 'none'; };
        redtag.addEventListener('change', syncRed);
        syncRed();
      }
    }
    document.querySelectorAll('.item').forEach(wireItem);
  });
</script>

{% if not read_only %}
<script>
(function () {
  const form = document.getElementById('inventory-form');
  if (!form) return;

  const toast = document.getElementById('draft-toast');

  // Pull server values from JSON blob (no Jinja in JS)
  let trailerId = 0, who = 'anon';
  try {
    const el = document.getElementById('inv-values');
    if (el) {
      const vals = JSON.parse(el.textContent || '{}');
      trailerId = Number(vals.trailer_id || 0);
      who = String(vals.who || 'anon');
    }
  } catch (_) {}
  const key = `inv_draft:${trailerId}:${who}`;

  // Robust CSS.escape fallback
  const cssEscape = (window.CSS && CSS.escape) ? CSS.escape : function (s) {
    return String(s).replace(/["\\]/g, '\\$&');
  };

  function showToast(msg){
    if (!toast) return;
    toast.textContent = msg;
    toast.classList.add('show');
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=>toast.classList.remove('show'), 1600);
  }

  function collectValues() {
    const data = {};
    form.querySelectorAll('input[name], textarea[name], select[name]').forEach(el => {
      if (el.type === 'checkbox' || el.type === 'radio') {
        data[el.name] = !!el.checked;
      } else {
        data[el.name] = el.value;
      }
    });
    // save open/closed sections keyed by data-cat
    const openCats = Array.from(document.querySelectorAll('.acc-item.open'))
      .map(el => el.getAttribute('data-cat'))
      .filter(Boolean);
    data.__open = openCats;
    data.__ts = Date.now();
    return data;
  }

  function applyValues(data) {
    Object.entries(data).forEach(([name, val]) => {
      if (name.startsWith('__')) return;
      const el = form.querySelector(`[name="${cssEscape(name)}"]`);
      if (!el) return;
      if (el.type === 'checkbox' || el.type === 'radio') {
        el.checked = !!val;
        el.dispatchEvent(new Event('change', { bubbles: true })); // update note toggles
      } else {
        el.value = val;
        el.dispatchEvent(new Event('input', { bubbles: true }));
      }
    });

    // restore open sections
    const openCats = Array.isArray(data.__open) ? data.__open : [];
    document.querySelectorAll('.acc-item').forEach(item => {
      const cat = item.getAttribute('data-cat');
      const shouldOpen = openCats.includes(cat);
      item.classList.toggle('open', shouldOpen);
      const header = item.querySelector('.acc-header');
      if (header) header.setAttribute('aria-expanded', shouldOpen ? 'true' : 'false');
    });

    // ensure note reveal states are correct
    document.querySelectorAll('.item').forEach(item => {
      const missing = item.querySelector('input[name$="_status_missing"], input[name^="cb_"][name$="_missing"]');
      const redtag  = item.querySelector('input[name$="_status_redtag"],  input[name^="cb_"][name$="_redtag"]');
      const noteMissing = item.querySelector('.note-missing');
      const noteRedtag  = item.querySelector('.note-redtag');
      if (noteMissing && missing) noteMissing.style.display = missing.checked ? 'block' : 'none';
      if (noteRedtag && redtag) noteRedtag.style.display = redtag.checked ? 'block' : 'none';
    });
  }

  function save() {
    try {
      const payload = collectValues();
      localStorage.setItem(key, JSON.stringify(payload));
      showToast('Draft saved');
    } catch (e) { /* ignore */ }
  }

  function restoreIfAny() {
    const raw = localStorage.getItem(key);
    if (!raw) return false;
    try {
      const data = JSON.parse(raw);
      applyValues(data);
      showToast('Draft restored');
      return true;
    } catch (e) { return false; }
  }

  // expose a tiny hook so accordion clicks can persist open state immediately
  window.__inv_saveOpenState = function(){
    try {
      const raw = localStorage.getItem(key);
      const data = raw ? JSON.parse(raw) : {};
      data.__open = Array.from(document.querySelectorAll('.acc-item.open'))
        .map(el => el.getAttribute('data-cat'))
        .filter(Boolean);
      data.__ts = Date.now();
      localStorage.setItem(key, JSON.stringify(data));
    } catch(e) {}
  };

  // Auto-restore (no prompt)
  restoreIfAny();

  // Debounced autosave on changes
  let t;
  function debouncedSave() { clearTimeout(t); t = setTimeout(save, 400); }
  form.addEventListener('input', debouncedSave);
  form.addEventListener('change', debouncedSave);

  // Save on unload as a safety net
  window.addEventListener('beforeunload', save);

  // Clear draft on successful submit
  form.addEventListener('submit', () => { localStorage.removeItem(key); });

  // Manual clear button
  const clearBtn = document.getElementById('clear-draft');
  if (clearBtn) {
    clearBtn.addEventListener('click', (e) => {
      e.preventDefault();
      localStorage.removeItem(key);
      showToast('Draft cleared');
    });
  }
})();
</script>
{% endif %}
{% endblock %}
